{% extends "base.html" %}
{% block content %}
<div class="container my-5">
  <h3 class="text-center mb-4">
    🔄 Compare: {{ compare_data.labels.A }} vs {{ compare_data.labels.B }}
  </h3>

  <div class="row">
    <!-- Monte Carlo Comparison -->
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-header">Monte Carlo Simulation</div>
        <div class="card-body">
          <canvas id="mcCompareChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Sensitivity Comparison -->
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-header">Sensitivity (Dollar Impact)</div>
        <div class="card-body">
          <canvas id="sensCompareChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center mt-4">
    <a href="{{ url_for('projects.retirement') }}" class="btn btn-secondary">
      ← Back to Planner
    </a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ---- data from Flask ----
  const ages  = {{ compare_data.mc.ages  | tojson }};
  const p10a  = {{ compare_data.mc.p10.A | tojson }};
  const p50a  = {{ compare_data.mc.p50.A | tojson }};
  const p90a  = {{ compare_data.mc.p90.A | tojson }};
  const p10b  = {{ compare_data.mc.p10.B | tojson }};
  const p50b  = {{ compare_data.mc.p50.B | tojson }};
  const p90b  = {{ compare_data.mc.p90.B | tojson }};

  const vars  = {{ compare_data.sens.vars | tojson }};
  const impA  = {{ compare_data.sens.A   | tojson }};
  const impB  = {{ compare_data.sens.B   | tojson }};

  // Optional y-axis cap supplied by the route (based on overlapped p90 maxima)
  const yMaxFromServer = {{ compare_data.mc.y_max | default('null') }};

  // Colors
  const cA = 'rgba(54,162,235,1)';     // blue (A)
  const cAfill = 'rgba(54,162,235,0.16)';
  const cB = 'rgba(255,159,64,1)';     // orange (B)
  const cBfill = 'rgba(255,159,64,0.16)';

  // Helpers
  const fmtMoney = v => '$' + Number(v).toLocaleString();

  // Compute a sane y max if server didn’t send one
  const yMaxLocal = Math.max(
    ...(p90a || []),
    ...(p90b || [])
  );
  const yMax = yMaxFromServer ?? Math.round(yMaxLocal * 1.1);

  // ---- Monte Carlo: shaded p10–p90 band + median line for each scenario ----
  new Chart(document.getElementById('mcCompareChart'), {
    type: 'line',
    data: {
      labels: ages,
      datasets: [
        // A band (order matters: put 90th first, then 10th with fill:'-1')
        { label: '{{ compare_data.labels.A }} – 90th %ile', data: p90a,
          borderWidth: 0, pointRadius: 0, fill: false },
        { label: '{{ compare_data.labels.A }} – 10th–90th band', data: p10a,
          borderWidth: 0, pointRadius: 0, fill: '-1', backgroundColor: cAfill },

        // A median
        { label: '{{ compare_data.labels.A }} – median', data: p50a,
          borderColor: cA, tension: 0.2, fill: false, pointRadius: 0, borderWidth: 2 },

        // B band
        { label: '{{ compare_data.labels.B }} – 90th %ile', data: p90b,
          borderWidth: 0, pointRadius: 0, fill: false },
        { label: '{{ compare_data.labels.B }} – 10th–90th band', data: p10b,
          borderWidth: 0, pointRadius: 0, fill: '-1', backgroundColor: cBfill },

        // B median
        { label: '{{ compare_data.labels.B }} – median', data: p50b,
          borderColor: cB, tension: 0.2, fill: false, pointRadius: 0, borderWidth: 2 },
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: { title: { display: true, text: 'Age' } },
        y: {
          suggestedMin: 0,
          suggestedMax: yMax,
          title: { display: true, text: 'Projected Assets ($)' },
          ticks: { callback: v => fmtMoney(v) }
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            // Show only the two median lines in the legend
            filter: (item) => item.text?.includes('median')
          }
        },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${fmtMoney(ctx.parsed.y)}`
          }
        }
      }
    }
  });

  // ---- Sensitivity ----
  const maxImp = Math.max(...impA.map(Math.abs), ...impB.map(Math.abs));

  new Chart(document.getElementById('sensCompareChart'), {
    type: 'bar',
    data: {
      labels: vars.map(v => v.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())),
      datasets: [
        { label: '{{ compare_data.labels.A }}', data: impA, backgroundColor: cAfill, borderColor: cA, borderWidth: 1 },
        { label: '{{ compare_data.labels.B }}', data: impB, backgroundColor: cBfill, borderColor: cB, borderWidth: 1 }
      ]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      scales: {
        x: {
          min: -maxImp, max: maxImp,
          title: { display: true, text: 'Dollar Impact ($)' },
          ticks: { callback: v => fmtMoney(v) }
        }
      },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${fmtMoney(ctx.parsed.x)}`
          }
        }
      }
    }
  });
</script>
{% endblock %}




