{% extends "base.html" %}
{% block content %}
<div class="container my-5">
  <!-- Comparison Header -->
  <h3 class="text-center mb-4">
    🔄 Compare: {{ compare_data.labels.A }} vs {{ compare_data.labels.B }}
  </h3>

  <div class="row">
    <!-- Monte Carlo Comparison -->
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-header">Monte Carlo Simulation</div>
        <div class="card-body">
          <canvas id="mcCompareChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Sensitivity Comparison -->
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-header">Sensitivity (Dollar Impact)</div>
        <div class="card-body">
          <canvas id="sensCompareChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Back button -->
  <div class="text-center mt-4">
    <a href="{{ url_for('projects.retirement') }}" class="btn btn-secondary">
      ← Back to Planner
    </a>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Data from Flask
  const ages    = {{ compare_data.mc.ages  | tojson }};
  const p10a    = {{ compare_data.mc.p10.A | tojson }};
  const p10b    = {{ compare_data.mc.p10.B | tojson }};
  const p50a    = {{ compare_data.mc.p50.A | tojson }};
  const p50b    = {{ compare_data.mc.p50.B | tojson }};
  const p90a    = {{ compare_data.mc.p90.A | tojson }};
  const p90b    = {{ compare_data.mc.p90.B | tojson }};

  const vars    = {{ compare_data.sens.vars | tojson }};
  const impactA = {{ compare_data.sens.A    | tojson }};
  const impactB = {{ compare_data.sens.B    | tojson }};
  const maxImp  = Math.max(...impactA.map(Math.abs), ...impactB.map(Math.abs));
  const safeMaxImp = maxImp === 0 ? 1 : maxImp;

  // Monte Carlo Comparison Chart
  new Chart(document.getElementById('mcCompareChart'), {
    type: 'line',
    data: {
      labels: ages,
      datasets: [
        {
          label: '{{ compare_data.labels.A }} – 10th %ile',
          data: p10a,
          borderColor: 'rgba(54,162,235,0.7)',
          borderDash: [5,5],
          fill: false
        },
        {
          label: '{{ compare_data.labels.B }} – 10th %ile',
          data: p10b,
          borderColor: 'rgba(255,159,64,0.7)',
          borderDash: [5,5],
          fill: false
        },
        {
          label: '{{ compare_data.labels.A }} – 50th %ile',
          data: p50a,
          borderColor: 'rgba(54,162,235,1)',
          fill: false
        },
        {
          label: '{{ compare_data.labels.B }} – 50th %ile',
          data: p50b,
          borderColor: 'rgba(255,159,64,1)',
          fill: false
        },
        {
          label: '{{ compare_data.labels.A }} – 90th %ile',
          data: p90a,
          borderColor: 'rgba(54,162,235,0.7)',
          borderDash: [2,2],
          fill: false
        },
        {
          label: '{{ compare_data.labels.B }} – 90th %ile',
          data: p90b,
          borderColor: 'rgba(255,159,64,0.7)',
          borderDash: [2,2],
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: { display: true, text: 'Age' }
        },
        y: {
          title: { display: true, text: 'Projected Assets ($)' },
          ticks: {
            callback: val => '$' + Number(val).toLocaleString()
          }
        }
      },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: $${Number(ctx.parsed.y).toLocaleString()}`
          }
        }
      }
    }
  });

  // Sensitivity Comparison Chart (horizontal, zero-centered)
  new Chart(document.getElementById('sensCompareChart'), {
    type: 'bar',
    data: {
      labels: vars.map(v => v.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase())),
      datasets: [
        {
          label: '{{ compare_data.labels.A }}',
          data: impactA,
          backgroundColor: 'rgba(54,162,235,0.5)'
        },
        {
          label: '{{ compare_data.labels.B }}',
          data: impactB,
          backgroundColor: 'rgba(255,159,64,0.5)'
        }
      ]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          min: -safeMaxImp,
          max:  safeMaxImp,
          title: { display: true, text: 'Dollar Impact ($)' },
          grid: { zeroLineColor: 'rgba(0,0,0,0.2)' },
          ticks: {
            callback: val => '$' + Number(val).toLocaleString()
          }
        }
      },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: ctx => {
              const v = Number(ctx.parsed.x);
              return `${ctx.dataset.label}: $${v.toLocaleString()}`;
            }
          }
        }
      }
    }
  });
</script>
{% endblock %}


